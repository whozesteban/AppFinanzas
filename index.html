<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Finanzas Personales</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Contenedor de Autenticaci√≥n -->
    <div id="auth-container">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Accede a tu Cuenta</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electr√≥nico</label>
                    <input type="email" id="email" placeholder="tu@email.com" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- Mensaje de Error -->
                <div id="error-message" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                
                <div class="flex items-center justify-between gap-4">
                    <button type="button" id="login-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Iniciar Sesi√≥n
                    </button>
                    <button type="button" id="register-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Registrarse
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicaci√≥n (Oculto por defecto) -->
    <div id="app-container" class="hidden w-full max-w-5xl p-4">
         <div class="bg-white p-8 rounded-lg shadow-md w-full">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Mis Finanzas üìä</h1>
                    <p class="text-gray-600">¬°Bienvenido! Aqu√≠ gestionar√°s tus finanzas personales.</p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cerrar Sesi√≥n
                </button>
            </div>
            
            <!-- Secci√≥n de Cuentas -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Mis Cuentas</h2>
                    <button id="add-account-btn" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300">
                        + A√±adir Cuenta
                    </button>
                </div>
                <div id="add-account-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <!-- Formulario de Cuenta aqu√≠... -->
                </div>
                <div id="accounts-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Las tarjetas de las cuentas se insertar√°n aqu√≠ din√°micamente -->
                </div>
            </div>

            <!-- Secci√≥n de Categor√≠as -->
            <div class="mt-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Mis Categor√≠as</h2>
                <form id="add-category-form" class="flex gap-2 mb-4">
                    <input type="text" id="category-name" placeholder="Ej. Comida, Transporte..." class="flex-grow mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline">A√±adir Categor√≠a</button>
                </form>
                <div id="categories-list" class="flex flex-wrap gap-2">
                    <!-- Las "pills" de categor√≠as se insertar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Secci√≥n de Transacciones -->
            <div class="mt-12">
                <div class="flex justify-between items-center mb-4">
                     <h2 class="text-2xl font-semibold text-gray-700">Transacciones Recientes</h2>
                     <div class="flex gap-2">
                        <button id="add-expense-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300">Nuevo Gasto</button>
                        <button id="add-income-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300">Nuevo Ingreso</button>
                     </div>
                </div>

                <!-- Formulario de Transacciones (Oculto) -->
                <div id="transaction-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h3 id="form-title" class="text-xl font-semibold text-gray-700 mb-4"></h3>
                    <form id="transaction-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="transaction-description" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                                <input type="text" id="transaction-description" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                             <div>
                                <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                                <input type="number" id="transaction-amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <div>
                                <label for="transaction-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="transaction-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="transaction-account" class="block text-sm font-medium text-gray-700">Cuenta</label>
                                <select id="transaction-account" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <!-- Opciones de cuenta se insertar√°n aqu√≠ -->
                                </select>
                            </div>
                        </div>
                        <!-- Contenedor del Selector de Categor√≠a (Oculto) -->
                        <div id="category-select-container" class="hidden">
                            <label for="transaction-category" class="block text-sm font-medium text-gray-700">Categor√≠a</label>
                            <select id="transaction-category" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <!-- Opciones de categor√≠a se insertar√°n aqu√≠ -->
                            </select>
                        </div>
                        <div class="mt-6 flex justify-end gap-4">
                            <button type="button" id="cancel-transaction-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Cancelar</button>
                            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar Transacci√≥n</button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Transacciones -->
                <div id="transactions-list" class="space-y-3">
                    <!-- Las transacciones se insertar√°n aqu√≠ -->
                </div>
            </div>
         </div>
    </div>

    <!-- L√≥gica de JavaScript y Firebase -->
    <script type="module">
        // Importa las funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot,
            doc,
            getDoc,
            updateDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCGofDOTMCRucjWzvnceT-d787mdnVzU7M",
          authDomain: "appfinanzaz.firebaseapp.com",
          projectId: "appfinanzaz",
          storageBucket: "appfinanzaz.firebasestorage.app",
          messagingSenderId: "695663371696",
          appId: "1:695663371696:web:500079de68b600da36a275",
          measurementId: "G-KEP5MGYDV3"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencias a elementos del DOM (Autenticaci√≥n y Cuentas sin cambios)
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const logoutBtn = document.getElementById('logout-btn');
        const accountsList = document.getElementById('accounts-list');

        // Referencias DOM de Categor√≠as
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryNameInput = document.getElementById('category-name');
        const categoriesList = document.getElementById('categories-list');
        
        // Referencias DOM de Transacciones
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const addIncomeBtn = document.getElementById('add-income-btn');
        const transactionFormContainer = document.getElementById('transaction-form-container');
        const transactionForm = document.getElementById('transaction-form');
        const formTitle = document.getElementById('form-title');
        const cancelTransactionBtn = document.getElementById('cancel-transaction-btn');
        const transactionAccountSelect = document.getElementById('transaction-account');
        const transactionsList = document.getElementById('transactions-list');
        const categorySelectContainer = document.getElementById('category-select-container');
        const transactionCategorySelect = document.getElementById('transaction-category');
        let currentTransactionType = null;

        let unsubscribeFromAccounts, unsubscribeFromTransactions, unsubscribeFromCategories;

        // --- L√≥gica de la interfaz de Transacciones ---
        const openTransactionForm = (type) => {
            currentTransactionType = type;
            formTitle.textContent = type === 'income' ? 'Nuevo Ingreso' : 'Nuevo Gasto';
            if (type === 'expense') {
                categorySelectContainer.classList.remove('hidden');
            } else {
                categorySelectContainer.classList.add('hidden');
            }
            transactionFormContainer.classList.remove('hidden');
        };
        const closeTransactionForm = () => {
            transactionFormContainer.classList.add('hidden');
            transactionForm.reset();
            currentTransactionType = null;
        };

        addIncomeBtn.addEventListener('click', () => openTransactionForm('income'));
        addExpenseBtn.addEventListener('click', () => openTransactionForm('expense'));
        cancelTransactionBtn.addEventListener('click', closeTransactionForm);

        // --- L√≥gica de Firestore: Categor√≠as ---
        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const categoryName = categoryNameInput.value.trim();
            if (!user || categoryName === '') return;

            try {
                const categoriesCollectionRef = collection(db, 'users', user.uid, 'categories');
                await addDoc(categoriesCollectionRef, { name: categoryName });
                categoryNameInput.value = '';
            } catch (error) {
                console.error("Error al a√±adir categor√≠a: ", error);
            }
        });

        // Event listener para eliminar categor√≠as (usando delegaci√≥n de eventos)
        categoriesList.addEventListener('click', async (e) => {
            if (e.target.matches('.delete-category-btn')) {
                const user = auth.currentUser;
                const categoryId = e.target.dataset.id;
                if (!user || !categoryId) return;
                const categoryRef = doc(db, 'users', user.uid, 'categories', categoryId);
                try {
                    await deleteDoc(categoryRef);
                } catch (error) {
                    console.error("Error al eliminar categor√≠a: ", error);
                }
            }
        });

        // --- L√≥gica de Firestore: Transacciones ---
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || !currentTransactionType) return;

            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const accountId = transactionAccountSelect.value;
            
            const newTransaction = {
                type: currentTransactionType,
                description: document.getElementById('transaction-description').value,
                amount: amount,
                date: document.getElementById('transaction-date').value,
                accountId: accountId,
                owner: user.uid
            };
            
            if (currentTransactionType === 'expense') {
                newTransaction.category = transactionCategorySelect.value;
            }

            try {
                await addDoc(collection(db, 'users', user.uid, 'transactions'), newTransaction);
                const accountRef = doc(db, 'users', user.uid, 'accounts', accountId);
                const accountSnap = await getDoc(accountRef);
                if (accountSnap.exists()) {
                    const currentBalance = accountSnap.data().balance;
                    const newBalance = currentTransactionType === 'income' ? currentBalance + amount : currentBalance - amount;
                    await updateDoc(accountRef, { balance: newBalance });
                }
                closeTransactionForm();
            } catch (error) {
                console.error("Error al guardar la transacci√≥n: ", error);
            }
        });
        
        // --- L√≥gica de Autenticaci√≥n, Cuentas (sin cambios mayores) ---

        // --- Observador del estado de autenticaci√≥n (L√≥gica Principal) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario autenticado
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                // Escuchar cambios en las cuentas
                const accountsQuery = query(collection(db, 'users', user.uid, 'accounts'));
                unsubscribeFromAccounts = onSnapshot(accountsQuery, (snapshot) => {
                    let accountsHtml = '';
                    let optionsHtml = '<option value="" disabled selected>Selecciona una cuenta</option>';
                    snapshot.forEach((doc) => {
                        const account = { id: doc.id, ...doc.data() };
                        const balanceColor = account.balance < 0 ? 'text-red-600' : 'text-green-600';
                        const formattedBalance = account.balance.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
                        
                        accountsHtml += `
                            <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg shadow-sm transition transform hover:scale-105">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-xl font-bold text-gray-800">${account.name}</h3>
                                    <span class="text-xs font-semibold text-indigo-800 bg-indigo-100 px-2 py-1 rounded-full">${account.type}</span>
                                </div>
                                <p class="text-3xl font-mono ${balanceColor} mt-4">${formattedBalance}</p>
                            </div>
                        `;
                        optionsHtml += `<option value="${account.id}">${account.name}</option>`;
                    });
                    accountsList.innerHTML = accountsHtml || '<p class="text-gray-500">A√∫n no tienes cuentas. ¬°A√±ade una para empezar!</p>';
                    transactionAccountSelect.innerHTML = optionsHtml;
                });

                // Escuchar cambios en las categor√≠as
                const categoriesQuery = query(collection(db, 'users', user.uid, 'categories'));
                unsubscribeFromCategories = onSnapshot(categoriesQuery, (snapshot) => {
                    let categoriesHtml = '';
                    let optionsHtml = '<option value="" disabled selected>Selecciona una categor√≠a</option>';
                    snapshot.forEach((doc) => {
                        const category = { id: doc.id, ...doc.data() };
                        categoriesHtml += `
                            <span class="flex items-center bg-blue-100 text-blue-800 text-sm font-medium pl-3 pr-1 py-1 rounded-full">
                                ${category.name}
                                <button data-id="${category.id}" class="delete-category-btn ml-2 text-blue-600 hover:text-blue-800">&times;</button>
                            </span>
                        `;
                        optionsHtml += `<option value="${category.name}">${category.name}</option>`;
                    });
                    categoriesList.innerHTML = categoriesHtml || '<p class="text-gray-500 text-sm">No tienes categor√≠as. A√±ade una arriba.</p>';
                    transactionCategorySelect.innerHTML = optionsHtml;
                });

                // Escuchar cambios en las transacciones
                const transactionsQuery = query(collection(db, 'users', user.uid, 'transactions'));
                 unsubscribeFromTransactions = onSnapshot(transactionsQuery, (snapshot) => {
                    let transactionsHtml = '';
                    snapshot.forEach((doc) => {
                        const transaction = doc.data();
                        const isIncome = transaction.type === 'income';
                        const amountColor = isIncome ? 'text-green-600' : 'text-red-600';
                        const sign = isIncome ? '+' : '-';
                        const formattedAmount = transaction.amount.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });

                        const categoryPill = transaction.category ? `<span class="text-xs font-semibold text-gray-600 bg-gray-200 px-2 py-1 rounded-full ml-2">${transaction.category}</span>` : '';

                        transactionsHtml += `
                            <div class="flex items-center justify-between p-3 bg-white border-b border-gray-200 rounded-md">
                                <div class="flex items-center">
                                    <div>
                                        <p class="font-semibold text-gray-800">${transaction.description}</p>
                                        <p class="text-sm text-gray-500">${new Date(transaction.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    </div>
                                    ${categoryPill}
                                </div>
                                <p class="font-semibold ${amountColor}">${sign}${formattedAmount}</p>
                            </div>
                        `;
                    });
                    transactionsList.innerHTML = transactionsHtml || '<p class="text-gray-500 text-center py-4">No hay transacciones recientes.</p>';
                });

            } else {
                // Usuario no autenticado
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                
                // Detener listeners de Firestore
                if (unsubscribeFromAccounts) unsubscribeFromAccounts();
                if (unsubscribeFromTransactions) unsubscribeFromTransactions();
                if (unsubscribeFromCategories) unsubscribeFromCategories();
                
                accountsList.innerHTML = '';
                transactionsList.innerHTML = '';
                categoriesList.innerHTML = '';
            }
        });
    </script>
</body>
</html>

