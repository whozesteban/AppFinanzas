<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Finanzas Personales</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Contenedor de Autenticaci√≥n -->
    <div id="auth-container">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Accede a tu Cuenta</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electr√≥nico</label>
                    <input type="email" id="email" placeholder="tu@email.com" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- Mensaje de Error -->
                <div id="error-message" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                
                <div class="flex items-center justify-between gap-4">
                    <button type="button" id="login-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Iniciar Sesi√≥n
                    </button>
                    <button type="button" id="register-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Registrarse
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicaci√≥n (Oculto por defecto) -->
    <div id="app-container" class="hidden w-full max-w-5xl p-4">
         <div class="bg-white p-8 rounded-lg shadow-md w-full">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Mis Finanzas üìä</h1>
                    <p class="text-gray-600">¬°Bienvenido! Aqu√≠ gestionar√°s tus finanzas personales.</p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cerrar Sesi√≥n
                </button>
            </div>
            
            <!-- Secci√≥n de Cuentas -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Mis Cuentas</h2>
                    <button id="add-account-btn" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300">
                        + A√±adir Cuenta
                    </button>
                </div>

                <!-- Formulario para A√±adir Cuenta (Oculto) -->
                <div id="add-account-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Nueva Cuenta</h3>
                    <form id="add-account-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="account-name" class="block text-sm font-medium text-gray-700">Nombre de la Cuenta</label>
                                <input type="text" id="account-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="account-type" class="block text-sm font-medium text-gray-700">Tipo de Cuenta</label>
                                <select id="account-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option>Ahorro</option>
                                    <option>D√©bito</option>
                                    <option>Cr√©dito</option>
                                    <option>Inversi√≥n</option>
                                    <option>Efectivo</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="initial-balance" class="block text-sm font-medium text-gray-700">Saldo Inicial ($)</label>
                            <input type="number" id="initial-balance" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mt-6 flex justify-end gap-4">
                            <button type="button" id="cancel-add-account-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                Guardar Cuenta
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Cuentas -->
                <div id="accounts-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Las tarjetas de las cuentas se insertar√°n aqu√≠ din√°micamente -->
                </div>
            </div>
         </div>
    </div>

    <!-- L√≥gica de JavaScript y Firebase -->
    <script type="module">
        // Importa las funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCGofDOTMCRucjWzvnceT-d787mdnVzU7M",
          authDomain: "appfinanzaz.firebaseapp.com",
          projectId: "appfinanzaz",
          storageBucket: "appfinanzaz.firebasestorage.app",
          messagingSenderId: "695663371696",
          appId: "1:695663371696:web:500079de68b600da36a275",
          measurementId: "G-KEP5MGYDV3"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencias a elementos del DOM de Autenticaci√≥n
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessageDiv = document.getElementById('error-message');

        // Referencias a elementos del DOM de Cuentas
        const addAccountBtn = document.getElementById('add-account-btn');
        const addAccountFormContainer = document.getElementById('add-account-form-container');
        const addAccountForm = document.getElementById('add-account-form');
        const cancelAddAccountBtn = document.getElementById('cancel-add-account-btn');
        const accountsList = document.getElementById('accounts-list');
        const accountNameInput = document.getElementById('account-name');
        const accountTypeInput = document.getElementById('account-type');
        const initialBalanceInput = document.getElementById('initial-balance');

        let unsubscribeFromAccounts; // Para detener el listener de Firestore al cerrar sesi√≥n

        // Funciones de UI
        const showError = (message) => {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        };
        const clearError = () => {
            errorMessageDiv.textContent = '';
            errorMessageDiv.classList.add('hidden');
        };

        // --- L√≥gica de la interfaz de Cuentas ---
        addAccountBtn.addEventListener('click', () => {
            addAccountFormContainer.classList.remove('hidden');
            addAccountBtn.classList.add('hidden');
        });

        cancelAddAccountBtn.addEventListener('click', () => {
            addAccountFormContainer.classList.add('hidden');
            addAccountBtn.classList.remove('hidden');
            addAccountForm.reset();
        });

        // --- L√≥gica de Firestore ---
        // Guardar nueva cuenta
        addAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const newAccount = {
                name: accountNameInput.value,
                type: accountTypeInput.value,
                balance: parseFloat(initialBalanceInput.value),
                owner: user.uid
            };

            try {
                const accountsCollectionRef = collection(db, 'users', user.uid, 'accounts');
                await addDoc(accountsCollectionRef, newAccount);
                console.log('Cuenta a√±adida con √©xito');
                addAccountForm.reset();
                addAccountFormContainer.classList.add('hidden');
                addAccountBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error al a√±adir la cuenta: ", error);
                // Aqu√≠ podr√≠as mostrar un error al usuario en la UI
            }
        });

        // --- Event Listeners para Autenticaci√≥n ---
        registerBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            clearError();
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showError("Por favor, ingresa email y contrase√±a.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') showError("Este correo electr√≥nico ya est√° en uso.");
                else if (error.code === 'auth/weak-password') showError("La contrase√±a debe tener al menos 6 caracteres.");
                else showError("Error al registrarse. Verifica tus datos.");
            }
        });

        loginBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            clearError();
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                showError("Por favor, ingresa email y contrase√±a.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showError("Email o contrase√±a incorrectos.");
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- Observador del estado de autenticaci√≥n (L√≥gica Principal) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario autenticado
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                // Escuchar cambios en las cuentas del usuario
                const accountsQuery = query(collection(db, 'users', user.uid, 'accounts'));
                unsubscribeFromAccounts = onSnapshot(accountsQuery, (snapshot) => {
                    let html = '';
                    snapshot.forEach((doc) => {
                        const account = doc.data();
                        const balanceColor = account.balance < 0 ? 'text-red-600' : 'text-green-600';
                        const formattedBalance = account.balance.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
                        
                        html += `
                            <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg shadow-sm transition transform hover:scale-105">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-xl font-bold text-gray-800">${account.name}</h3>
                                    <span class="text-xs font-semibold text-indigo-800 bg-indigo-100 px-2 py-1 rounded-full">${account.type}</span>
                                </div>
                                <p class="text-3xl font-mono ${balanceColor} mt-4">${formattedBalance}</p>
                            </div>
                        `;
                    });
                    accountsList.innerHTML = html || '<p class="text-gray-500">A√∫n no tienes cuentas. ¬°A√±ade una para empezar!</p>';
                });

            } else {
                // Usuario no autenticado
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                emailInput.value = '';
                passwordInput.value = '';
                clearError();

                // Detener el listener de Firestore si existe
                if (unsubscribeFromAccounts) {
                    unsubscribeFromAccounts();
                }
                accountsList.innerHTML = ''; // Limpiar la lista de cuentas
            }
        });
    </script>
</body>
</html>

