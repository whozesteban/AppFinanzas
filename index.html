<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Finanzas Personales</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Contenedor de Autenticaci√≥n -->
    <div id="auth-container">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Accede a tu Cuenta</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electr√≥nico</label>
                    <input type="email" id="email" placeholder="tu@email.com" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="error-message" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <div class="flex items-center justify-between gap-4">
                    <button type="button" id="login-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Iniciar Sesi√≥n</button>
                    <button type="button" id="register-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Registrarse</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicaci√≥n (Oculto por defecto) -->
    <div id="app-container" class="hidden w-full max-w-5xl p-4">
         <div class="bg-white p-8 rounded-lg shadow-md w-full">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
                <div class="mb-4 sm:mb-0">
                    <h1 class="text-3xl font-bold text-gray-800">Mis Finanzas üìä</h1>
                    <p class="text-gray-600">¬°Bienvenido! Aqu√≠ gestionar√°s tus finanzas personales.</p>
                </div>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline self-start sm:self-center">Cerrar Sesi√≥n</button>
            </div>
            
            <div id="dashboard-section" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Resumen Mensual</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-green-100 p-4 rounded-lg text-center shadow">
                        <p class="text-sm font-medium text-green-800">Ingresos (30 d√≠as)</p>
                        <h2 id="summary-income" class="text-2xl font-bold text-green-900 mt-1">$0.00</h2>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg text-center shadow">
                        <p class="text-sm font-medium text-red-800">Gastos (30 d√≠as)</p>
                        <h2 id="summary-expense" class="text-2xl font-bold text-red-900 mt-1">$0.00</h2>
                    </div>
                    <div id="summary-balance-card" class="bg-gray-100 p-4 rounded-lg text-center shadow">
                        <p id="summary-balance-title" class="text-sm font-medium text-gray-800">Balance (30 d√≠as)</p>
                        <h2 id="summary-balance" class="text-2xl font-bold text-gray-900 mt-1">$0.00</h2>
                    </div>
                </div>
                <div class="w-full md:w-1/2 lg:w-1/3 mx-auto">
                    <canvas id="category-chart"></canvas>
                </div>
            </div>

            <div id="accounts-section" class="mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Mis Cuentas</h2>
                    <button id="add-account-btn" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300">+ A√±adir Cuenta</button>
                </div>
                <div id="add-account-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Nueva Cuenta</h3>
                    <form id="add-account-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="account-name" class="block text-sm font-medium text-gray-700">Nombre de la Cuenta</label>
                                <input type="text" id="account-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="account-type" class="block text-sm font-medium text-gray-700">Tipo de Cuenta</label>
                                <select id="account-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <option>Ahorro</option>
                                    <option>D√©bito</option>
                                    <option>Cr√©dito</option>
                                    <option>Inversi√≥n</option>
                                    <option>Efectivo</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="initial-balance" class="block text-sm font-medium text-gray-700">Saldo Inicial ($)</label>
                            <input type="number" id="initial-balance" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mt-6 flex justify-end gap-4">
                            <button type="button" id="cancel-add-account-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Guardar Cuenta</button>
                        </div>
                    </form>
                </div>
                <div id="accounts-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="categories-section" class="mt-12">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Mis Categor√≠as</h2>
                <form id="add-category-form" class="flex gap-2 mb-4">
                    <input type="text" id="category-name" placeholder="Ej. Comida, Transporte..." class="flex-grow mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">A√±adir Categor√≠a</button>
                </form>
                <div id="categories-list" class="flex flex-wrap gap-2"></div>
            </div>

            <div id="transactions-section" class="mt-12">
                 <div class="flex justify-between items-center mb-4">
                     <h2 class="text-2xl font-semibold text-gray-700">Transacciones</h2>
                     <div class="flex flex-wrap gap-2">
                        <button id="add-expense-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full">Nuevo Gasto</button>
                        <button id="add-income-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">Nuevo Ingreso</button>
                        <button id="add-transfer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-full">Transferencia</button>
                     </div>
                </div>

                <div id="transfer-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Realizar Transferencia</h3>
                    <form id="transfer-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="transfer-from-account" class="block text-sm font-medium text-gray-700">Cuenta de Origen</label>
                                <select id="transfer-from-account" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="transfer-to-account" class="block text-sm font-medium text-gray-700">Cuenta de Destino</label>
                                <select id="transfer-to-account" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="transfer-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                                <input type="number" id="transfer-amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="transfer-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="transfer-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <div>
                           <label for="transfer-description" class="block text-sm font-medium text-gray-700">Descripci√≥n (Opcional)</label>
                           <input type="text" id="transfer-description" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="mt-6 flex justify-end gap-4">
                            <button type="button" id="cancel-transfer-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                            <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">Guardar Transferencia</button>
                        </div>
                    </form>
                </div>
                <div id="transaction-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h3 id="form-title" class="text-xl font-semibold text-gray-700 mb-4"></h3>
                    <form id="transaction-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="transaction-description" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                                <input type="text" id="transaction-description" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                             <div>
                                <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                                <input type="number" id="transaction-amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                             <div>
                                <label for="transaction-date-normal" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="transaction-date-normal" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="transaction-account" class="block text-sm font-medium text-gray-700">Cuenta</label>
                                <select id="transaction-account" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></select>
                            </div>
                        </div>
                        <div id="category-select-container" class="hidden mt-4">
                            <label for="transaction-category" class="block text-sm font-medium text-gray-700">Categor√≠a</label>
                            <select id="transaction-category" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></select>
                        </div>
                        <div class="mt-4 md:col-span-2">
                            <label for="transaction-notes" class="block text-sm font-medium text-gray-700">Notas (Opcional)</label>
                            <textarea id="transaction-notes" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div class="mt-6 flex justify-end gap-4">
                            <button type="button" id="cancel-transaction-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Guardar Transacci√≥n</button>
                        </div>
                    </form>
                </div>
                <div id="transactions-list" class="space-y-3"></div>
            </div>

            <div id="debts-section" class="mt-12">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Gesti√≥n de Deudas</h2>
                    <button id="add-debt-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full">+ A√±adir Deuda</button>
                </div>
                <div id="add-debt-form-container" class="hidden bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Nueva Deuda</h3>
                    <form id="add-debt-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="debt-name" class="block text-sm font-medium text-gray-700">Nombre de la Deuda</label>
                            <input type="text" id="debt-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="debt-total-amount" class="block text-sm font-medium text-gray-700">Monto Total ($)</label>
                            <input type="number" id="debt-total-amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2 mt-2 flex justify-end gap-4">
                            <button type="button" id="cancel-add-debt-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Guardar Deuda</button>
                        </div>
                    </form>
                </div>
                <div id="debts-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
         </div>

        <div id="make-payment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
            <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
                <h3 id="payment-modal-title" class="text-lg font-medium leading-6 text-gray-900 mb-4">Hacer un Pago</h3>
                <form id="make-payment-form">
                    <input type="hidden" id="payment-debt-id">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="payment-amount" class="block text-sm font-medium text-gray-700">Monto a Pagar ($)</label>
                            <input type="number" id="payment-amount" step="0.01" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="payment-account" class="block text-sm font-medium text-gray-700">Pagar desde la cuenta</label>
                            <select id="payment-account" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm"></select>
                        </div>
                        <div>
                            <label for="payment-date" class="block text-sm font-medium text-gray-700">Fecha del Pago</label>
                            <input type="date" id="payment-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-4">
                        <button type="button" id="cancel-payment-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                        <button type="submit" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Confirmar Pago</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, getDoc, updateDoc, deleteDoc, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCGofDOTMCRucjWzvnceT-d787mdnVzU7M",
          authDomain: "appfinanzaz.firebaseapp.com",
          projectId: "appfinanzaz",
          storageBucket: "appfinanzaz.firebasestorage.app",
          messagingSenderId: "695663371696",
          appId: "1:695663371696:web:500079de68b600da36a275",
          measurementId: "G-KEP5MGYDV3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Referencias a elementos del DOM ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const errorMessageDiv = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logout-btn');
        
        const addAccountBtn = document.getElementById('add-account-btn');
        const addAccountFormContainer = document.getElementById('add-account-form-container');
        const addAccountForm = document.getElementById('add-account-form');
        const cancelAddAccountBtn = document.getElementById('cancel-add-account-btn');
        const accountsList = document.getElementById('accounts-list');
        const accountNameInput = document.getElementById('account-name');
        const accountTypeInput = document.getElementById('account-type');
        const initialBalanceInput = document.getElementById('initial-balance');

        const addCategoryForm = document.getElementById('add-category-form');
        const categoryNameInput = document.getElementById('category-name');
        const categoriesList = document.getElementById('categories-list');

        const transactionsList = document.getElementById('transactions-list');
        const transactionForm = document.getElementById('transaction-form');
        const transactionFormContainer = document.getElementById('transaction-form-container');
        const formTitle = document.getElementById('form-title');
        const categorySelectContainer = document.getElementById('category-select-container');
        
        const transferFormContainer = document.getElementById('transfer-form-container');
        const transferForm = document.getElementById('transfer-form');
        
        const debtsList = document.getElementById('debts-list');
        const addDebtBtn = document.getElementById('add-debt-btn');
        const addDebtFormContainer = document.getElementById('add-debt-form-container');
        const addDebtForm = document.getElementById('add-debt-form');
        const cancelAddDebtBtn = document.getElementById('cancel-add-debt-btn');
        const makePaymentModal = document.getElementById('make-payment-modal');
        const makePaymentForm = document.getElementById('make-payment-form');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const paymentModalTitle = document.getElementById('payment-modal-title');
        const paymentDebtIdInput = document.getElementById('payment-debt-id');
        const paymentAccountSelect = document.getElementById('payment-account');
        
        const summaryIncomeEl = document.getElementById('summary-income');
        const summaryExpenseEl = document.getElementById('summary-expense');
        const summaryBalanceEl = document.getElementById('summary-balance');
        const summaryBalanceCard = document.getElementById('summary-balance-card');
        const summaryBalanceTitle = document.getElementById('summary-balance-title');

        let categoryChart; 
        let unsubscribeFromAccounts, unsubscribeFromTransactions, unsubscribeFromCategories, unsubscribeFromDebts;
        let currentTransactionType = null;

        const formatCurrency = (value) => value.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });

        // --- Funciones de UI ---
        const showError = (message) => { errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden'); };
        const clearError = () => { errorMessageDiv.textContent = ''; errorMessageDiv.classList.add('hidden'); };
        const openTransactionForm = (type) => { currentTransactionType = type; formTitle.textContent = type === 'income' ? 'Nuevo Ingreso' : 'Nuevo Gasto'; categorySelectContainer.classList.toggle('hidden', type !== 'expense'); transactionFormContainer.classList.remove('hidden'); };
        const closeTransactionForm = () => { transactionFormContainer.classList.add('hidden'); transactionForm.reset(); currentTransactionType = null; };
        const openTransferForm = () => transferFormContainer.classList.remove('hidden');
        const closeTransferForm = () => { transferFormContainer.classList.add('hidden'); transferForm.reset(); };

        // --- Listeners de UI (Completos) ---
        const addIncomeBtn = document.getElementById('add-income-btn');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const addTransferBtn = document.getElementById('add-transfer-btn');
        const cancelTransactionBtn = document.getElementById('cancel-transaction-btn');
        const cancelTransferBtn = document.getElementById('cancel-transfer-btn');

        addIncomeBtn.addEventListener('click', () => openTransactionForm('income'));
        addExpenseBtn.addEventListener('click', () => openTransactionForm('expense'));
        addTransferBtn.addEventListener('click', openTransferForm);
        cancelTransactionBtn.addEventListener('click', closeTransactionForm);
        cancelTransferBtn.addEventListener('click', closeTransferForm);
        addDebtBtn.addEventListener('click', () => addDebtFormContainer.classList.remove('hidden'));
        cancelAddDebtBtn.addEventListener('click', () => addDebtFormContainer.classList.add('hidden'));
        cancelPaymentBtn.addEventListener('click', () => makePaymentModal.classList.add('hidden'));
        addAccountBtn.addEventListener('click', () => { addAccountFormContainer.classList.remove('hidden'); addAccountBtn.classList.add('hidden'); });
        cancelAddAccountBtn.addEventListener('click', () => { addAccountFormContainer.classList.add('hidden'); addAccountBtn.classList.remove('hidden'); addAccountForm.reset(); });
        
        // --- L√≥gica de Firestore ---
        addAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            try {
                const newAccount = {
                    name: accountNameInput.value,
                    type: accountTypeInput.value,
                    balance: parseFloat(initialBalanceInput.value),
                    owner: user.uid,
                };
                await addDoc(collection(db, 'users', user.uid, 'accounts'), newAccount);
                addAccountForm.reset();
                addAccountFormContainer.classList.add('hidden');
                addAccountBtn.classList.remove('hidden');
            } catch (error) {
                console.error("Error adding account:", error);
            }
        });

        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const categoryName = categoryNameInput.value.trim();
            if (!user || categoryName === '') return;
            try {
                await addDoc(collection(db, 'users', user.uid, 'categories'), { name: categoryName });
                categoryNameInput.value = '';
            } catch (error) {
                console.error("Error adding category:", error);
            }
        });

        categoriesList.addEventListener('click', async (e) => {
            if (e.target.matches('.delete-category-btn')) {
                const user = auth.currentUser;
                const categoryId = e.target.dataset.id;
                if (!user || !categoryId) return;
                try {
                    await deleteDoc(doc(db, 'users', user.uid, 'categories', categoryId));
                } catch (error) {
                    console.error("Error deleting category:", error);
                }
            }
        });

        addDebtForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            const newDebt = {
                name: document.getElementById('debt-name').value,
                totalAmount: parseFloat(document.getElementById('debt-total-amount').value),
                amountPaid: 0,
                owner: user.uid
            };
            try {
                await addDoc(collection(db, 'users', user.uid, 'debts'), newDebt);
                addDebtForm.reset();
                addDebtFormContainer.classList.add('hidden');
            } catch (error) {
                console.error("Error adding debt:", error);
            }
        });
        
        debtsList.addEventListener('click', (e) => {
            if (e.target.matches('.make-payment-btn')) {
                const debtId = e.target.dataset.debtId;
                const debtName = e.target.dataset.debtName;
                const debtRemaining = e.target.dataset.debtRemaining;
                
                paymentModalTitle.textContent = `Hacer un Pago a "${debtName}"`;
                paymentDebtIdInput.value = debtId;
                document.getElementById('payment-amount').max = debtRemaining;
                makePaymentModal.classList.remove('hidden');
            }
        });

        makePaymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const debtId = paymentDebtIdInput.value;
            const accountId = paymentAccountSelect.value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            if (!user || !debtId || !accountId || !amount || !date) return alert("Por favor, completa todos los campos.");
            const debtRef = doc(db, 'users', user.uid, 'debts', debtId);
            const accountRef = doc(db, 'users', user.uid, 'accounts', accountId);
            try {
                const debtDocForName = await getDoc(debtRef);
                if (!debtDocForName.exists()) throw "La deuda no existe.";
                await runTransaction(db, async (transaction) => {
                    const debtDoc = await transaction.get(debtRef);
                    const accountDoc = await transaction.get(accountRef);
                    if (!debtDoc.exists() || !accountDoc.exists()) throw "La deuda o la cuenta no existen.";
                    const debtData = debtDoc.data();
                    const accountData = accountDoc.data();
                    if (accountData.balance < amount) throw "Fondos insuficientes en la cuenta de origen.";
                    if (amount > (debtData.totalAmount - debtData.amountPaid)) throw "El monto del pago excede el saldo restante de la deuda.";
                    transaction.update(debtRef, { amountPaid: debtData.amountPaid + amount });
                    transaction.update(accountRef, { balance: accountData.balance - amount });
                });
                await addDoc(collection(db, 'users', user.uid, 'transactions'), {
                    type: 'expense',
                    description: `Pago a ${debtDocForName.data().name}`,
                    amount: amount,
                    date: date,
                    accountId: accountId,
                    category: 'Pago de Deudas',
                    owner: user.uid
                });
                makePaymentModal.classList.add('hidden');
                makePaymentForm.reset();
            } catch (error) {
                console.error("Error al procesar el pago:", error);
                alert("Error: " + error);
            }
        });

        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const fromAccountId = document.getElementById('transfer-from-account').value;
            const toAccountId = document.getElementById('transfer-to-account').value;
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const date = document.getElementById('transfer-date').value;
            const description = document.getElementById('transfer-description').value;

            if (fromAccountId === toAccountId) return alert("La cuenta de origen y destino no pueden ser la misma.");
            if (amount <= 0) return alert("El monto de la transferencia debe ser mayor a cero.");

            const fromAccountRef = doc(db, 'users', user.uid, 'accounts', fromAccountId);
            const toAccountRef = doc(db, 'users', user.uid, 'accounts', toAccountId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const fromDoc = await transaction.get(fromAccountRef);
                    const toDoc = await transaction.get(toAccountRef);
                    if (!fromDoc.exists() || !toDoc.exists()) throw "Una de las cuentas no existe.";
                    const fromBalance = fromDoc.data().balance;
                    if (fromBalance < amount) throw "Fondos insuficientes en la cuenta de origen.";
                    transaction.update(fromAccountRef, { balance: fromBalance - amount });
                    transaction.update(toAccountRef, { balance: toDoc.data().balance + amount });
                });
                closeTransferForm();
            } catch (error) {
                console.error("Error en la transferencia: ", error);
                alert("Error en la transferencia: " + error);
            }
        });
        
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || !currentTransactionType) return;

            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const accountId = document.getElementById('transaction-account').value;
            const notes = document.getElementById('transaction-notes').value.trim();

            if (!accountId) return alert("Por favor, selecciona una cuenta.");

            const newTransaction = {
                type: currentTransactionType,
                description: document.getElementById('transaction-description').value,
                amount: amount,
                date: document.getElementById('transaction-date-normal').value,
                accountId: accountId,
                owner: user.uid
            };

            if (notes) newTransaction.notes = notes;
            if (currentTransactionType === 'expense') {
                const category = document.getElementById('transaction-category').value;
                if (category) newTransaction.category = category;
            }

            try {
                await addDoc(collection(db, 'users', user.uid, 'transactions'), newTransaction);
                const accountRef = doc(db, 'users', user.uid, 'accounts', accountId);
                const accountSnap = await getDoc(accountRef);
                if (accountSnap.exists()) {
                    const currentBalance = accountSnap.data().balance;
                    const newBalance = currentTransactionType === 'income' ? currentBalance + amount : currentBalance - amount;
                    await updateDoc(accountRef, { balance: newBalance });
                }
                closeTransactionForm();
            } catch (error) {
                console.error("Error al guardar la transacci√≥n: ", error);
                alert("Hubo un error al guardar la transacci√≥n.");
            }
        });

        transactionsList.addEventListener('click', async (e) => {
            if (e.target.matches('.delete-transaction-btn')) {
                const user = auth.currentUser;
                const { id, type, amount, accountId } = e.target.dataset;
                if (!user || !id) return;
                if (confirm('¬øEst√°s seguro de que quieres eliminar esta transacci√≥n? Esta acci√≥n es irreversible.')) {
                    const amountNum = parseFloat(amount);
                    const accountRef = doc(db, 'users', user.uid, 'accounts', accountId);
                    const transactionRef = doc(db, 'users', user.uid, 'transactions', id);
                    try {
                        await runTransaction(db, async (transaction) => {
                            const accountDoc = await transaction.get(accountRef);
                            if (!accountDoc.exists()) throw "La cuenta asociada ya no existe.";
                            const currentBalance = accountDoc.data().balance;
                            const newBalance = type === 'income' ? currentBalance - amountNum : currentBalance + amountNum;
                            transaction.update(accountRef, { balance: newBalance });
                        });
                        await deleteDoc(transactionRef);
                    } catch (error) {
                        console.error("Error al eliminar la transacci√≥n:", error);
                        alert("Error al eliminar: " + error);
                    }
                }
            }
        });

        // --- L√≥gica de Autenticaci√≥n ---
        loginBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            clearError();
            try {
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                showError("Email o contrase√±a incorrectos.");
            }
        });

        registerBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            clearError();
            try {
                await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') showError("Este correo electr√≥nico ya est√° en uso.");
                else if (error.code === 'auth/weak-password') showError("La contrase√±a debe tener al menos 6 caracteres.");
                else showError("Error al registrarse. Verifica tus datos.");
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- Observador del estado de autenticaci√≥n ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                appContainer.classList.remove('hidden');
                authContainer.classList.add('hidden');

                const accountsQuery = query(collection(db, 'users', user.uid, 'accounts'));
                unsubscribeFromAccounts = onSnapshot(accountsQuery, (snapshot) => {
                    let accountsHtml = '';
                    let optionsHtml = '<option value="" disabled selected>Selecciona una cuenta</option>';
                    snapshot.forEach((doc) => {
                        const account = { id: doc.id, ...doc.data() };
                        
                        const balanceColor = account.balance < 0 ? 'text-red-600' : 'text-green-600';
                        const formattedBalance = formatCurrency(account.balance);
                        
                        accountsHtml += `
                            <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg shadow-sm transition transform hover:scale-105">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-xl font-bold text-gray-800">${account.name}</h3>
                                    <span class="text-xs font-semibold text-indigo-800 bg-indigo-100 px-2 py-1 rounded-full">${account.type}</span>
                                </div>
                                <p class="text-3xl font-mono ${balanceColor} mt-4">${formattedBalance}</p>
                            </div>
                        `;
                        optionsHtml += `<option value="${account.id}">${account.name} (${formattedBalance})</option>`;
                    });
                    accountsList.innerHTML = accountsHtml || '<p class="text-gray-500 col-span-full">A√∫n no tienes cuentas. ¬°A√±ade una para empezar!</p>';
                    document.getElementById('transaction-account').innerHTML = optionsHtml;
                    document.getElementById('transfer-from-account').innerHTML = optionsHtml;
                    document.getElementById('transfer-to-account').innerHTML = optionsHtml;
                    paymentAccountSelect.innerHTML = optionsHtml;
                });
                
                // (Resto de onSnapshot listeners)
                 const categoriesQuery = query(collection(db, 'users', user.uid, 'categories'));
                unsubscribeFromCategories = onSnapshot(categoriesQuery, (snapshot) => {
                    let categoriesHtml = '';
                    let optionsHtml = '<option value="" disabled selected>Selecciona una categor√≠a</option>';
                    snapshot.forEach((doc) => {
                        const category = { id: doc.id, ...doc.data() };
                        categoriesHtml += `
                            <span class="flex items-center bg-blue-100 text-blue-800 text-sm font-medium pl-3 pr-1 py-1 rounded-full">
                                ${category.name}
                                <button data-id="${category.id}" class="delete-category-btn ml-2 text-blue-600 hover:text-blue-800 font-bold">&times;</button>
                            </span>
                        `;
                        optionsHtml += `<option value="${category.name}">${category.name}</option>`;
                    });
                    categoriesList.innerHTML = categoriesHtml || '<p class="text-gray-500 text-sm">No tienes categor√≠as. A√±ade una arriba.</p>';
                    document.getElementById('transaction-category').innerHTML = optionsHtml;
                });

                const debtsQuery = query(collection(db, 'users', user.uid, 'debts'));
                unsubscribeFromDebts = onSnapshot(debtsQuery, (snapshot) => {
                    let debtsHtml = '';
                    snapshot.forEach((doc) => {
                        const debt = { id: doc.id, ...doc.data() };
                        const remaining = debt.totalAmount - debt.amountPaid;
                        const progress = (debt.totalAmount > 0) ? (debt.amountPaid / debt.totalAmount) * 100 : 0;
                        debtsHtml += `
                        <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-gray-800">${debt.name}</h3>
                                <span class="text-sm font-semibold ${remaining <= 0 ? 'text-green-800 bg-green-100' : 'text-purple-800 bg-purple-100'} px-2 py-1 rounded-full">
                                    ${remaining <= 0 ? 'Pagada' : 'Pendiente'}
                                </span>
                            </div>
                            <p class="text-gray-600 mt-2">${formatCurrency(debt.amountPaid)} de ${formatCurrency(debt.totalAmount)} pagados</p>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            ${remaining > 0 ? `
                            <div class="text-right mt-4">
                                <button class="make-payment-btn bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded text-sm"
                                    data-debt-id="${debt.id}" data-debt-name="${debt.name}" data-debt-remaining="${remaining}">
                                    Hacer un Pago
                                </button>
                            </div>
                            ` : ''}
                        </div>`;
                    });
                    debtsList.innerHTML = debtsHtml || '<p class="text-gray-500 col-span-full">No tienes deudas registradas. ¬°Felicidades!</p>';
                });

                const transactionsQuery = query(collection(db, 'users', user.uid, 'transactions'));
                unsubscribeFromTransactions = onSnapshot(transactionsQuery, (snapshot) => {
                    const allTransactions = [];
                    snapshot.forEach(doc => allTransactions.push({ id: doc.id, ...doc.data() }));
                    
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const totalIncome = allTransactions.filter(t => t.type === 'income' && new Date(t.date) >= thirtyDaysAgo).reduce((sum, t) => sum + t.amount, 0);
                    const recentExpenses = allTransactions.filter(t => t.type === 'expense' && new Date(t.date) >= thirtyDaysAgo);
                    const totalExpense = recentExpenses.reduce((sum, t) => sum + t.amount, 0);
                    const balance = totalIncome - totalExpense;

                    summaryIncomeEl.textContent = formatCurrency(totalIncome);
                    summaryExpenseEl.textContent = formatCurrency(totalExpense);
                    summaryBalanceEl.textContent = formatCurrency(balance);
                    
                    summaryBalanceCard.classList.remove('bg-green-100', 'bg-red-100');
                    summaryBalanceTitle.classList.remove('text-green-800', 'text-red-800');
                    summaryBalanceEl.classList.remove('text-green-900', 'text-red-900');
                    if (balance >= 0) {
                        summaryBalanceCard.classList.add('bg-green-100');
                        summaryBalanceTitle.classList.add('text-green-800');
                        summaryBalanceEl.classList.add('text-green-900');
                    } else {
                        summaryBalanceCard.classList.add('bg-red-100');
                        summaryBalanceTitle.classList.add('text-red-800');
                        summaryBalanceEl.classList.add('text-red-900');
                    }
                    
                    const expensesByCategory = {};
                    recentExpenses.forEach(t => {
                        const category = t.category || 'Sin Categor√≠a';
                        expensesByCategory[category] = (expensesByCategory[category] || 0) + t.amount;
                    });
                    
                    const labels = Object.keys(expensesByCategory);
                    const data = Object.values(expensesByCategory);

                    if (categoryChart) categoryChart.destroy();
                    
                    const ctx = document.getElementById('category-chart').getContext('2d');
                    categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Gastos por Categor√≠a',
                                data: data,
                                backgroundColor: ['rgba(255, 99, 132, 0.8)','rgba(54, 162, 235, 0.8)','rgba(255, 206, 86, 0.8)','rgba(75, 192, 192, 0.8)','rgba(153, 102, 255, 0.8)','rgba(255, 159, 64, 0.8)'],
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'top' } } }
                    });

                    const accountNames = {};
                    getDocs(accountsQuery).then(accountSnapshot => {
                        let transactionsHtml = '';
                        accountSnapshot.forEach(doc => { accountNames[doc.id] = doc.data().name; });

                        allTransactions.forEach((transaction) => {
                            const formattedAmount = formatCurrency(transaction.amount);
                            let transactionHtml = '';
                            const notesIcon = transaction.notes ? `<div class="relative group ml-2"><span class="text-gray-400 cursor-pointer">‚ÑπÔ∏è</span><div class="absolute bottom-0 left-5 mb-6 hidden group-hover:block w-48 bg-gray-800 text-white text-xs rounded py-2 px-3 z-10">${transaction.notes}</div></div>` : '';
                            const deleteButton = `<button class="delete-transaction-btn text-gray-400 hover:text-red-500 text-2xl leading-none ml-2" data-id="${transaction.id}" data-type="${transaction.type}" data-amount="${transaction.amount}" data-account-id="${transaction.accountId}">&times;</button>`;

                            switch(transaction.type) {
                                case 'income':
                                    transactionHtml = `<div class="flex items-center justify-between p-3 bg-white border-b border-gray-200 rounded-md shadow-sm"><div class="flex items-center"><div><p class="font-semibold text-gray-800">${transaction.description}</p><p class="text-sm text-gray-500">${new Date(transaction.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p></div>${notesIcon}</div><div class="flex items-center"><p class="font-semibold text-green-600">+${formattedAmount}</p>${deleteButton}</div></div>`;
                                    break;
                                case 'expense':
                                    const categoryPill = transaction.category ? `<span class="text-xs font-semibold text-gray-600 bg-gray-200 px-2 py-1 rounded-full ml-2">${transaction.category}</span>` : '';
                                    transactionHtml = `<div class="flex items-center justify-between p-3 bg-white border-b border-gray-200 rounded-md shadow-sm"><div class="flex items-center"><div><p class="font-semibold text-gray-800">${transaction.description}</p><p class="text-sm text-gray-500">${new Date(transaction.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p></div>${categoryPill}${notesIcon}</div><div class="flex items-center"><p class="font-semibold text-red-600">-${formattedAmount}</p>${deleteButton}</div></div>`;
                                    break;
                                case 'transfer-out': case 'transfer-in':
                                    const isOut = transaction.type === 'transfer-out';
                                    const transferDesc = transaction.description || (isOut ? `a ${accountNames[transaction.toAccount] || '...'}` : `desde ${accountNames[transaction.fromAccount] || '...'}`);
                                    transactionHtml = `<div class="flex items-center justify-between p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-md"><div class="flex items-center"><span class="mr-3 text-yellow-600">üîÅ</span><div><p class="font-semibold text-gray-800">Transferencia ${transferDesc}</p><p class="text-sm text-gray-500">${new Date(transaction.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p></div></div><p class="font-semibold ${isOut ? 'text-red-600' : 'text-green-600'}">${isOut ? '-' : '+'}${formattedAmount}</p></div>`;
                                    break;
                            }
                            transactionsHtml += transactionHtml;
                        });
                        transactionsList.innerHTML = transactionsHtml || '<p class="text-gray-500 text-center py-4">No hay transacciones recientes.</p>';
                    });
                });

            } else {
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                if (unsubscribeFromAccounts) unsubscribeFromAccounts();
                if (unsubscribeFromCategories) unsubscribeFromCategories();
                if (unsubscribeFromTransactions) unsubscribeFromTransactions();
                if (unsubscribeFromDebts) unsubscribeFromDebts();
                if (categoryChart) { categoryChart.destroy(); categoryChart = null; }
            }
        });
    </script>
</body>
</html>

